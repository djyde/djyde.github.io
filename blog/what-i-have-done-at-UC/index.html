<!DOCTYPE html><html data-saber-ssr><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.10.3"> <title>我在 UC 做的前端工程化探索 - Randy&#x27;s Blog</title> <link data-saber-head="ssr" rel="stylesheet" href="//ppp.djyde.com/css?family=Noto+Serif+SC"><style data-vue-ssr-id="1baa226e:0 4c8acc66:0 e37f2252:0">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{-webkit-box-sizing:content-box;box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:rgba(0,0,0,0)}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{-webkit-box-sizing:border-box;box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{-webkit-box-sizing:border-box;box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}body{font-family:"Noto Serif SC",Lusitana,serif;line-height:1.4rem}blockquote{margin:0;padding:0 0 0 1.5rem;border-left:.5rem solid #ccc}a{color:#333;-webkit-transition:all .2s;transition:all .2s;text-decoration:none}a:hover{color:#000}a.big{padding-left:.25rem;padding-right:.25rem;border-bottom:.25rem solid #1a1a1a}a.big:hover{background-color:#000;color:#fff}.twitter{color:#0c9df2}.zhihu{color:#0767c8}.weibo{color:#e80025}.github{color:#333}.medium{color:#00ab6b}.email{color:#4285f4}.telegram{color:#179cde}.hr{height:0;font-size:1rem;line-height:0;text-transform:uppercase;text-align:center;border-bottom:1px solid #ccc;margin-top:2rem;margin-bottom:2rem;cursor:default;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.hr span{background-color:#fff;padding-left:.5em;padding-right:.5em;color:#ccc}li{margin-bottom:.5rem}h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,PingFang SC,Hiragino Sans GB,Microsoft Yahei,sans-serif}#footer{margin-top:2em;padding:1em;background-color:#fafafa;text-align:center}#footer,#footer a{color:#c0c5ce}
code[class*=language-][data-v-c316f882],pre[class*=language-][data-v-c316f882]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-][data-v-c316f882]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-][data-v-c316f882],pre[class*=language-][data-v-c316f882]{background:#282a36}:not(pre)>code[class*=language-][data-v-c316f882]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata[data-v-c316f882],.token.comment[data-v-c316f882],.token.doctype[data-v-c316f882],.token.prolog[data-v-c316f882]{color:#6272a4}.token.punctuation[data-v-c316f882]{color:#f8f8f2}.namespace[data-v-c316f882]{opacity:.7}.token.constant[data-v-c316f882],.token.deleted[data-v-c316f882],.token.property[data-v-c316f882],.token.symbol[data-v-c316f882],.token.tag[data-v-c316f882]{color:#ff79c6}.token.boolean[data-v-c316f882],.token.number[data-v-c316f882]{color:#bd93f9}.token.attr-name[data-v-c316f882],.token.builtin[data-v-c316f882],.token.char[data-v-c316f882],.token.inserted[data-v-c316f882],.token.selector[data-v-c316f882],.token.string[data-v-c316f882]{color:#50fa7b}.language-css .token.string[data-v-c316f882],.style .token.string[data-v-c316f882],.token.entity[data-v-c316f882],.token.operator[data-v-c316f882],.token.url[data-v-c316f882],.token.variable[data-v-c316f882]{color:#f8f8f2}.token.atrule[data-v-c316f882],.token.attr-value[data-v-c316f882],.token.class-name[data-v-c316f882],.token.function[data-v-c316f882]{color:#f1fa8c}.token.keyword[data-v-c316f882]{color:#8be9fd}.token.important[data-v-c316f882],.token.regex[data-v-c316f882]{color:#ffb86c}.token.bold[data-v-c316f882],.token.important[data-v-c316f882]{font-weight:700}.token.italic[data-v-c316f882]{font-style:italic}.token.entity[data-v-c316f882]{cursor:help}.saber-highlight code[data-v-c316f882]{font-size:.5rem}.post-footer[data-v-c316f882]{padding-top:2rem;text-align:center;color:#65737e}.post-footer p[data-v-c316f882]{margin-top:.5em;margin-bottom:.5em}.bmc[data-v-c316f882]{max-width:30%!important}@media (min-width:320px) and (max-width:479px){.bmc[data-v-c316f882]{max-width:100%!important}}.cover[data-v-c316f882]{padding-bottom:40%}@media (min-width:320px) and (max-width:479px){.cover[data-v-c316f882]{padding-bottom:75%}}.cover[data-v-c316f882]{background-size:cover;background-position:50%}.post[data-v-c316f882]{margin-top:4rem}.post h1[data-v-c316f882],.post h2[data-v-c316f882],.post h3[data-v-c316f882],.post h4[data-v-c316f882],.post h5[data-v-c316f882],.post h6[data-v-c316f882]{margin:4rem 0 0}.post strong[data-v-c316f882]{background-color:#e6e6e6;color:#000;padding-left:.25rem;padding-right:.25rem}.post .title[data-v-c316f882]{margin-bottom:1rem}.post .date[data-v-c316f882]{color:grey}@media (min-width:1025px){.post[data-v-c316f882]{width:960px;margin:0 auto}}@media (min-width:320px) and (max-width:479px){.post[data-v-c316f882]{padding-left:5%;padding-right:5%}.post img[data-v-c316f882]{width:100%}}@media (min-width:481px) and (max-width:1024px){.post[data-v-c316f882]{padding-left:5%;padding-right:5%}}.post .content img[data-v-c316f882]{max-width:100%;display:block;margin:0 auto}@media (min-width:481px) and (max-width:1024px){.post .content img[data-v-c316f882]{width:100%}}@media (min-width:320px) and (max-width:479px){.post .content img[data-v-c316f882]{width:100%}}.post .content p[data-v-c316f882]{line-height:1.8rem}.post .content a[data-v-c316f882]{padding-left:.25rem;padding-right:.25rem;border-bottom:.25rem solid #1a1a1a}.post .content a[data-v-c316f882]:hover{background-color:#000;color:#fff}.footer[data-v-c316f882]{text-align:center}
nav[data-v-634644b4]{background-color:#000}nav .logo[data-v-634644b4]{padding-left:1rem;margin-right:2rem;display:inline-block}nav .logo a[data-v-634644b4]{font-weight:700;color:#fff}nav .nav-item[data-v-634644b4]{display:inline-block}nav .nav-item a[data-v-634644b4]{display:block;color:#fff;padding:.5rem}nav .nav-item a[data-v-634644b4]:hover{color:#000;background-color:#fff}</style>  </head><body><div id="_saber" data-server-rendered="true"><div><div data-v-c316f882><nav data-v-634644b4 data-v-c316f882><div class="logo" data-v-634644b4><a href="/" class="router-link-active" data-v-634644b4>Randy's Blog</a></div> <div class="nav-item" data-v-634644b4><a href="/readings" data-v-634644b4>Readings</a></div></nav> <!----> <div class="post" data-v-c316f882><h1 class="title" data-v-c316f882>我在 UC 做的前端工程化探索</h1> <div class="date" data-v-c316f882>September 27, 2019</div> <div class="content" data-v-c316f882><p data-v-c316f882>我在 2016 年初加入 UC 的国际业务部，负责为 UC News 搭建运营后台。随着前端团队人数越来越多，我开始推动团队的前端技术栈统一以及前端工程化，开发了一个叫 Cans 用于快速搭建中后台前端应用的框架。直到了 2019 年我离开 UC, Cans 仍然服务于 UC 的国际业务。</p> <p data-v-c316f882>本文主要记录了我如何从 UC News 运营后台孵化出这个内部框架，以及其背后的设计理念。虽然 Cans 没有开放源代码。但我认为相比这些工具的源码，那些我在开发这些工具背后的理念、思考，更有被分享的价值。也算作是对我在 UC 工作的一个总结。遂有此文。</p> <hr data-v-c316f882> <p data-v-c316f882>我们在做 UC News 运营后台的时候，面临的最大问题是：当有新的业务需要我们团队支撑开发一个新运营后台的时候，我们应该怎么做？</p> <p data-v-c316f882>这种情况在不断地发生。2017 年我们的 UC News 运营后台趋于成熟，业务需求响应的速度在不断提高。越来越多业务方问我们同一个问题：「我们 xxx 业务想有一个运营后台，我们可以快速接入吗？」</p> <p data-v-c316f882>如何让 UC News 运营后台的开发经验可以被快速地复制出去，帮助更多业务？在回答这个问题之前，我想先说说我是怎么设计 UC News 运营后台的前端工程以提高需求响应速度的。</p> <p data-v-c316f882>第一点是保证业务开发尽量不被构建环节干扰，只须关注业务逻辑本身。这一点很好保证，因为构建配置基本是不需要更改的。</p> <p data-v-c316f882>第二点是降低新页面接入的成本。所谓的成本指的是：</p> <ul data-v-c316f882><li data-v-c316f882>页面绑定对应的路由</li> <li data-v-c316f882>在左侧菜单栏添加菜单项并指向对应的路由</li></ul> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_185.JPG?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_186.JPG?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882>我把这两点变成配置项，可以直接在项目里的 routes 文件配置。这样新页面接入只需配置菜单项的标题和路由，以及对应的页面组件即可。</p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_E5C7A707793A-1.jpeg?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882>第三点是规范项目目录结构。这一点我在 <a rel="noopener noreferrer" target="_blank" href="https://eggjs.org" data-v-c316f882>Egg</a> 上受到很大的启发。在内部，我们的 Node.js 系统都使用 Egg. 我借鉴 Egg 把项目配置、路由配置、应用启动代码等作了规范：</p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_15A76FD02171-1.jpeg?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882>要用这一套模式赋能更多不断冒出的新业务，首先要做的是统一。</p> <p data-v-c316f882>在社区上做开源软件和做公司内部的软件不同，前者通常需要考虑兼容性。处理兼容性的代价是越来越复杂的配置项。但做内部软件，则可以通过「统一」简化配置（甚至无需配置）。例如，两个业务如果分别使用 less 和 sass, 那么在新建项目时，两个业务都要各自配置。相反，如果早已约定所有业务都使用 less, 那么 less 的配置可以固化到统一的工具里，两个业务都不需配置。</p> <p data-v-c316f882>首先是技术栈的统一：</p> <ul data-v-c316f882><li data-v-c316f882>React</li> <li data-v-c316f882>组件库：Ant.Design</li> <li data-v-c316f882>构建工具：Webpack</li> <li data-v-c316f882>语言：TypeScript</li> <li data-v-c316f882>css 预编译：Less</li></ul> <p data-v-c316f882>技术栈的选型背后没有什么高深的思量，不过是这一套在 UC News 运营后台经过了考验：Ant.Design 的组件覆盖了 90% 的需求；纯 EcmaScript 写运营后台这种复杂应用是灾难，尤其在新人接手的时候；</p> <p data-v-c316f882><strong data-v-c316f882>技术栈的统一带来的是构建配置可以全部收敛</strong>，当然除了技术相关的工具，还有业务层面的工具可以统一收敛：</p> <ul data-v-c316f882><li data-v-c316f882>构建产物发布到 cdn</li> <li data-v-c316f882>打点、错误监控的封装</li> <li data-v-c316f882>网络请求库统一</li> <li data-v-c316f882>i18n 方案统一</li></ul> <p data-v-c316f882>做好了这些统一的准备，我开始开发一个叫 Cans 的前端解决方案，它的宗旨是快速搭建中后台类的项目。</p> <h2 id="框架设计" data-v-c316f882>框架设计</h2> <p data-v-c316f882>「开箱即用，没有多余的东西」是我从 <a rel="noopener noreferrer" target="_blank" href="http://zeit.co" data-v-c316f882>zeit.co</a> 领会到的软件设计哲学。<strong data-v-c316f882>如果说一个框架设计得美，那么其实是说它用最简单且符合直觉的接口封装了最复杂的逻辑</strong>。</p> <p data-v-c316f882>和 next.js 一样，我希望开发者只要用 <code data-v-c316f882>cans start</code> 这一条命令，就能开始开发一个页面。</p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_5861AF8C8CB1-1.jpeg?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882>在最基本的应用，<code data-v-c316f882>cans start</code> 的背后会做这样的工作：</p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_366CDF4D0EEB-1.jpeg?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882>也就是收集所有运行时将要用到的数据，然后生成一个入口 js 文件。</p> <p data-v-c316f882>另外，在构建中还引入了 tree shaking, code splitting (with react-loadable) 等等优化手段。</p> <p data-v-c316f882>构建时分析的应用数据，可以在运行时、页面中通过 import app 实例来获取：</p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_4F51DBF1C4FE-1.jpeg?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882>这种注入机制是为了提供扩展性，为了通过这种扩展性建立「生态」，Cans 引入了 addon 机制，以一个打点 addon 为例：</p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_F7A689CCF2ED-1.jpeg?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882>开发者可以在 npm 发布以 <code data-v-c316f882>cans-addon-</code> 为前缀的库贡献生态。</p> <p data-v-c316f882>Cans 自带了一些业务常用的 addon:</p> <ul data-v-c316f882><li data-v-c316f882>cans-addon-cookies
<ul data-v-c316f882><li data-v-c316f882>通过<code data-v-c316f882>app.cookies.get</code> 和 <code data-v-c316f882>app.cookies.set</code> 读写 cookies</li></ul></li> <li data-v-c316f882>cans-addon-storage
<ul data-v-c316f882><li data-v-c316f882>通过<code data-v-c316f882>app.storage</code> 做离线数据持久化（如本地数据缓存）</li></ul></li> <li data-v-c316f882>cans-addon-http
<ul data-v-c316f882><li data-v-c316f882>http 请求方法封闭</li></ul></li></ul> <p data-v-c316f882>虽然中后台的布局千篇一律，但为了尽量覆盖所有定制化的需求，Cans 也开放了 theme, 开发者可以定制自己的主题，用 <code data-v-c316f882>app.theme()</code> 引入。也可以在 npm 上贡献主题。像我们最常用的运营后台 theme：</p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/0653a32a-c51b-4a14-9bb3-a3298c151d87.png?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_44DD0DC7FA9F-1.jpeg?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882>而在业务层，尽可能将可复用的业务组件封装出去，让更多业务可以使用。如 <a rel="noopener noreferrer" target="_blank" href="https://github.com/NewbeeFE/antd-data-table" data-v-c316f882>antd-data-table</a> 这个业务组件，就是从 UC News 运营后台独立出来的。</p> <p data-v-c316f882><img src="https://gbstatic.djyde.com/blog/what-i-have-done-at-uc/IMG_3BCAB3A24856-1.jpeg?x-oss-process=style/80" alt="" data-v-c316f882></p> <p data-v-c316f882>以上是 Cans 这个框架的大概模样, 或有其它细节，但不是本文的重点。</p> <p data-v-c316f882>在设计这个框架的时候，我无时无刻在考虑的是如何使开发者要写的代码越来越少，同时开放的接口是要符合开发者直觉的。就像「建立一个页面就是创建一个页面文件然后运行 <code data-v-c316f882>cans start</code> 一样简单。</p> <p data-v-c316f882>几年前我读了《乔布斯传》，使我对用户体验有了极致的追求，也把这种追求带到了软件开发。这种体验不是一句 Simple is better 就可以说明的。你在同时面对一堆电路板和一台 Macintosh 的时候可能才会体会到所谓的「科技与人文的十字路口」，但，软件设计同样有这样的十字路口，它可能出现在一份完整、漂亮的文档（像 Vue）, 可能出现在一个屏蔽了所有复杂细节 (and it just works!) 的命令（像 next.js）, 可能出现在它的小而美，可以接入到任何地方。</p> <p data-v-c316f882>后来蚂蚁金服发布了 Umi, 比 Cans 做得更全面，但两者的思路都如出一辙。我想这证明了这套模式背后的价值所在。最近看到<a rel="noopener noreferrer" target="_blank" href="https://www.yuque.com/preview/yuque/0/2019/pdf/84184/1569318486837-37eeba0d-ebc1-452a-9f6a-a6a02cd27726.pdf" data-v-c316f882>《Umi 架构、生态和未来》</a> ，让我更确信当初的想法和 Umi 在做的是契合的。推荐各位在下一个项目可以试试 Umi.</p> <p data-v-c316f882>记得有一次面试的时候，我提到我主要是做一些前端基建的工作，面试官问我，觉得什么样的前端基建是做得好的基建？我回答说，<strong data-v-c316f882>如果我做的基建可以让同事少加班，那么我做的基建就是好的</strong>。</p></div> <div class="post-footer" data-v-c316f882><hr data-v-c316f882> <p data-v-c316f882>讨论请发邮件到 randypriv@gmail.com</p> <p data-v-c316f882>未经授权，禁止转载</p> <p data-v-c316f882>通过支付宝 djyde520@gmail.com 或赞赏码赞助此文</p> <p data-v-c316f882>
        或通过订阅我的
        <a href="/blog/my-zsxq/" data-v-c316f882>知识星球</a>支持本博客
      </p> <br data-v-c316f882> <p data-v-c316f882><img src="//gbstatic.djyde.com/assets/006tKfTcgy1fkuufy2cadj30w00w0tb2.jpg" class="bmc" data-v-c316f882></p></div></div></div> <div id="footer"><p><img width="256px" src="//s2.ax1x.com/2019/04/04/A2V9YT.png"></p> <p>
      2014-2019
      <a href="/" class="router-link-active">Randy's Blog</a></p></div></div></div><script src="/_saber/js/client.990198f0.js" defer></script><script src="/_saber/js/page--_posts-what-i-have-done-at-UC-md.09472075.js" defer></script></body></html>
