<!DOCTYPE html><html data-saber-ssr><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.10.3"> <title>搭建自己的 Gitlab CI Runner - Randy&#x27;s Blog</title> <link data-saber-head="ssr" rel="stylesheet" href="//ppp.djyde.com/css?family=Noto+Serif+SC"><style data-vue-ssr-id="1baa226e:0 4c8acc66:0 e37f2252:0">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{-webkit-box-sizing:content-box;box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:rgba(0,0,0,0)}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{-webkit-box-sizing:border-box;box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{-webkit-box-sizing:border-box;box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}body{font-family:"Noto Serif SC",Lusitana,serif;line-height:1.4rem}blockquote{margin:0;padding:0 0 0 1.5rem;border-left:.5rem solid #ccc}a{color:#333;-webkit-transition:all .2s;transition:all .2s;text-decoration:none}a:hover{color:#000}a.big{padding-left:.25rem;padding-right:.25rem;border-bottom:.25rem solid #1a1a1a}a.big:hover{background-color:#000;color:#fff}.twitter{color:#0c9df2}.zhihu{color:#0767c8}.weibo{color:#e80025}.github{color:#333}.medium{color:#00ab6b}.email{color:#4285f4}.telegram{color:#179cde}.hr{height:0;font-size:1rem;line-height:0;text-transform:uppercase;text-align:center;border-bottom:1px solid #ccc;margin-top:2rem;margin-bottom:2rem;cursor:default;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.hr span{background-color:#fff;padding-left:.5em;padding-right:.5em;color:#ccc}li{margin-bottom:.5rem}h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,PingFang SC,Hiragino Sans GB,Microsoft Yahei,sans-serif}#footer{margin-top:2em;padding:1em;background-color:#fafafa;text-align:center}#footer,#footer a{color:#c0c5ce}
code[class*=language-][data-v-c316f882],pre[class*=language-][data-v-c316f882]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-][data-v-c316f882]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-][data-v-c316f882],pre[class*=language-][data-v-c316f882]{background:#282a36}:not(pre)>code[class*=language-][data-v-c316f882]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata[data-v-c316f882],.token.comment[data-v-c316f882],.token.doctype[data-v-c316f882],.token.prolog[data-v-c316f882]{color:#6272a4}.token.punctuation[data-v-c316f882]{color:#f8f8f2}.namespace[data-v-c316f882]{opacity:.7}.token.constant[data-v-c316f882],.token.deleted[data-v-c316f882],.token.property[data-v-c316f882],.token.symbol[data-v-c316f882],.token.tag[data-v-c316f882]{color:#ff79c6}.token.boolean[data-v-c316f882],.token.number[data-v-c316f882]{color:#bd93f9}.token.attr-name[data-v-c316f882],.token.builtin[data-v-c316f882],.token.char[data-v-c316f882],.token.inserted[data-v-c316f882],.token.selector[data-v-c316f882],.token.string[data-v-c316f882]{color:#50fa7b}.language-css .token.string[data-v-c316f882],.style .token.string[data-v-c316f882],.token.entity[data-v-c316f882],.token.operator[data-v-c316f882],.token.url[data-v-c316f882],.token.variable[data-v-c316f882]{color:#f8f8f2}.token.atrule[data-v-c316f882],.token.attr-value[data-v-c316f882],.token.class-name[data-v-c316f882],.token.function[data-v-c316f882]{color:#f1fa8c}.token.keyword[data-v-c316f882]{color:#8be9fd}.token.important[data-v-c316f882],.token.regex[data-v-c316f882]{color:#ffb86c}.token.bold[data-v-c316f882],.token.important[data-v-c316f882]{font-weight:700}.token.italic[data-v-c316f882]{font-style:italic}.token.entity[data-v-c316f882]{cursor:help}.saber-highlight code[data-v-c316f882]{font-size:.5rem}.post-footer[data-v-c316f882]{padding-top:2rem;text-align:center;color:#65737e}.post-footer p[data-v-c316f882]{margin-top:.5em;margin-bottom:.5em}.bmc[data-v-c316f882]{max-width:30%!important}@media (min-width:320px) and (max-width:479px){.bmc[data-v-c316f882]{max-width:100%!important}}.cover[data-v-c316f882]{padding-bottom:40%}@media (min-width:320px) and (max-width:479px){.cover[data-v-c316f882]{padding-bottom:75%}}.cover[data-v-c316f882]{background-size:cover;background-position:50%}.post[data-v-c316f882]{margin-top:4rem}.post h1[data-v-c316f882],.post h2[data-v-c316f882],.post h3[data-v-c316f882],.post h4[data-v-c316f882],.post h5[data-v-c316f882],.post h6[data-v-c316f882]{margin:4rem 0 0}.post strong[data-v-c316f882]{background-color:#e6e6e6;color:#000;padding-left:.25rem;padding-right:.25rem}.post .title[data-v-c316f882]{margin-bottom:1rem}.post .date[data-v-c316f882]{color:grey}@media (min-width:1025px){.post[data-v-c316f882]{width:960px;margin:0 auto}}@media (min-width:320px) and (max-width:479px){.post[data-v-c316f882]{padding-left:5%;padding-right:5%}.post img[data-v-c316f882]{width:100%}}@media (min-width:481px) and (max-width:1024px){.post[data-v-c316f882]{padding-left:5%;padding-right:5%}}.post .content img[data-v-c316f882]{max-width:100%;display:block;margin:0 auto}@media (min-width:481px) and (max-width:1024px){.post .content img[data-v-c316f882]{width:100%}}@media (min-width:320px) and (max-width:479px){.post .content img[data-v-c316f882]{width:100%}}.post .content p[data-v-c316f882]{line-height:1.8rem}.post .content a[data-v-c316f882]{padding-left:.25rem;padding-right:.25rem;border-bottom:.25rem solid #1a1a1a}.post .content a[data-v-c316f882]:hover{background-color:#000;color:#fff}.footer[data-v-c316f882]{text-align:center}
nav[data-v-634644b4]{background-color:#000}nav .logo[data-v-634644b4]{padding-left:1rem;margin-right:2rem;display:inline-block}nav .logo a[data-v-634644b4]{font-weight:700;color:#fff}nav .nav-item[data-v-634644b4]{display:inline-block}nav .nav-item a[data-v-634644b4]{display:block;color:#fff;padding:.5rem}nav .nav-item a[data-v-634644b4]:hover{color:#000;background-color:#fff}</style>  </head><body><div id="_saber" data-server-rendered="true"><div><div data-v-c316f882><nav data-v-634644b4 data-v-c316f882><div class="logo" data-v-634644b4><a href="/" class="router-link-active" data-v-634644b4>Randy's Blog</a></div> <div class="nav-item" data-v-634644b4><a href="/readings" data-v-634644b4>Readings</a></div></nav> <!----> <div class="post" data-v-c316f882><h1 class="title" data-v-c316f882>搭建自己的 Gitlab CI Runner</h1> <div class="date" data-v-c316f882>April 20, 2017</div> <div class="content" data-v-c316f882><blockquote data-v-c316f882><p data-v-c316f882>假定你已经有一台可用的，可联网的机器</p></blockquote> <h2 id="preface" data-v-c316f882>Preface</h2> <p data-v-c316f882>这篇文章将介绍如何使用自己的机器来搭建用于 Gitlab CI 的 runner.  在搭建自己的 CI Runner 之前，需要先明确一些概念：</p> <h3 id="ci-continuous-integration" data-v-c316f882>CI (Continuous Integration)</h3> <p data-v-c316f882>CI 的全称是 Continuous Integration (持续集成)，是 extreme programming (极限编程) 的一部分。我们常用 CI 来做一些自动化工作，这种自动化工作会运行在一台集中的机器上，比如程序的打包，单元测试，部署等。这种构建方式避免了了打包环境差异引动的错误，并且通过 Gitlab 的 hook, 在代码提交的各个环节自动地完成一系列的构建工作。</p> <h3 id="ci-runner" data-v-c316f882>CI Runner</h3> <p data-v-c316f882>和第三方的 Travis CI, CircleCI 不同，<strong data-v-c316f882>Gitlab 本身并不提供机器</strong>，只提供一个注册机器的接口。这些机器用于运行构建逻辑，在 Gitlab 中被称为 Runner.</p> <p data-v-c316f882><img src="//gbstatic.djyde.com/assets/006tNc79gy1fet5ffxwglj31ac0y2wj8.jpg" alt="runners" data-v-c316f882></p> <h2 id="gitlab-runner-环境" data-v-c316f882>Gitlab Runner 环境</h2> <p data-v-c316f882>在这里直接使用 Gitlab Runner 的官方 docker image:</p> <h3 id="安装-docker" data-v-c316f882>安装 Docker</h3> <div class="saber-highlight" data-lang="bash" data-v-c316f882><pre class="saber-highlight-code language-bash" data-v-c316f882><code class="language-bash" data-v-c316f882><span class="token function" data-v-c316f882>curl</span> -sSL https://get.daocloud.io/docker <span class="token operator" data-v-c316f882>|</span> <span class="token function" data-v-c316f882>sh</span></code></pre></div><h3 id="拉取-gitlab-runner-镜像" data-v-c316f882>拉取 gitlab-runner 镜像</h3> <p data-v-c316f882>因为众所周知的原因，国内 pull docker 镜像非常不稳定，所以在这里用 Daocloud 提供的镜像：</p> <div class="saber-highlight" data-lang="bash" data-v-c316f882><pre class="saber-highlight-code language-bash" data-v-c316f882><code class="language-bash" data-v-c316f882><span class="token function" data-v-c316f882>curl</span> -sSL https://get.daocloud.io/daotools/set_mirror.sh <span class="token operator" data-v-c316f882>|</span> <span class="token function" data-v-c316f882>sh</span> -s http://718dbf2d.m.daocloud.io

<span class="token function" data-v-c316f882>sudo</span> <span class="token function" data-v-c316f882>service</span> docker restart</code></pre></div><p data-v-c316f882>拉取镜像：</p> <div class="saber-highlight" data-lang="bash" data-v-c316f882><pre class="saber-highlight-code language-bash" data-v-c316f882><code class="language-bash" data-v-c316f882><span class="token function" data-v-c316f882>sudo</span> docker pull gitlab/gitlab-runner:latest</code></pre></div><h3 id="添加-gitlab-runner-container" data-v-c316f882>添加 gitlab-runner container</h3> <div class="saber-highlight" data-lang="bash" data-v-c316f882><pre class="saber-highlight-code language-bash" data-v-c316f882><code class="language-bash" data-v-c316f882><span class="token function" data-v-c316f882>sudo</span> docker run -d --name gitlab-runner --restart always <span class="token punctuation" data-v-c316f882>\</span>
  -v /srv/gitlab-runner/config:/etc/gitlab-runner <span class="token punctuation" data-v-c316f882>\</span>
  -v /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation" data-v-c316f882>\</span>
  gitlab/gitlab-runner:latest</code></pre></div><h3 id="配置用于-runner-的-docker-image" data-v-c316f882>配置用于 runner 的 docker image</h3> <blockquote data-v-c316f882><p data-v-c316f882>虽然 Gitlab 支持多种 runner 运行方式，但本文建议使用 docker，因为使用 docker 较为灵活，一台机器可以创建多个 docker images 分别为不同的项目进行 CI, 但仍能保持环境隔离。</p></blockquote> <p data-v-c316f882>配置 Docker image 最简单的方式是写 <code data-v-c316f882>Dockerfile</code>, 比如可以用 Node.js 官方的 Docker image:</p> <div class="saber-highlight" data-lang="dockerfile" data-v-c316f882><pre class="saber-highlight-code language-dockerfile" data-v-c316f882><code class="language-dockerfile" data-v-c316f882><span class="token comment" data-v-c316f882># Dockerfile</span>
<span class="token keyword" data-v-c316f882>FROM</span> node<span class="token punctuation" data-v-c316f882>:</span>7.9.0</code></pre></div><p data-v-c316f882>由于每个业务总会有各自的环境要求，比如应用依赖底层的库。这时可以通过 <code data-v-c316f882>Dockerfile</code> 配置：</p> <div class="saber-highlight" data-lang="dockerfile" data-v-c316f882><pre class="saber-highlight-code language-dockerfile" data-v-c316f882><code class="language-dockerfile" data-v-c316f882><span class="token comment" data-v-c316f882># Dockerfile</span>
<span class="token keyword" data-v-c316f882>FROM</span> node<span class="token punctuation" data-v-c316f882>:</span>7.9.0

<span class="token keyword" data-v-c316f882>RUN</span> apt<span class="token punctuation" data-v-c316f882>-</span>get update &amp;&amp; apt<span class="token punctuation" data-v-c316f882>-</span>get install <span class="token punctuation" data-v-c316f882>-</span>y \
	package<span class="token punctuation" data-v-c316f882>-</span>foo
	package<span class="token punctuation" data-v-c316f882>-</span>bar</code></pre></div><h3 id="构建-docker-image" data-v-c316f882>构建 Docker Image</h3> <p data-v-c316f882>写好 <code data-v-c316f882>Dockerfile</code> 后，需要把它构建成 Image:</p> <div class="saber-highlight" data-lang="bash" data-v-c316f882><pre class="saber-highlight-code language-bash" data-v-c316f882><code class="language-bash" data-v-c316f882><span class="token function" data-v-c316f882>ls</span>
<span class="token comment" data-v-c316f882># Dockerfile</span>

docker build -t IMAGE_NAME <span class="token builtin class-name" data-v-c316f882>.</span></code></pre></div><p data-v-c316f882>Build 完后，通过 <code data-v-c316f882>sudo docker image ls</code> 查看 image 状态。</p> <h3 id="注册-runner" data-v-c316f882>注册 Runner</h3> <p data-v-c316f882>接下来就可以注册 Runner:</p> <div class="saber-highlight" data-lang="bash" data-v-c316f882><pre class="saber-highlight-code language-bash" data-v-c316f882><code class="language-bash" data-v-c316f882><span class="token function" data-v-c316f882>sudo</span> docker <span class="token builtin class-name" data-v-c316f882>exec</span> -it gitlab-runner gitlab-ci-multi-runner register</code></pre></div><p data-v-c316f882>程序会要求你填写相关的信息，这些信息可以从 Gitlab 项目的 <code data-v-c316f882>Settings -&gt; Runners</code> 页面中找到：</p> <p data-v-c316f882><img src="//gbstatic.djyde.com/assets/006tNc79gy1fetavn7r0lj319u0os78u.jpg" alt="Gitlab runner info" data-v-c316f882></p> <div class="saber-highlight" data-lang="bash" data-v-c316f882><pre class="saber-highlight-code language-bash" data-v-c316f882><code class="language-bash" data-v-c316f882>Please enter the gitlab-ci coordinator URL:
<span class="token comment" data-v-c316f882># http://gitlab.alibaba-inc.com/ci</span>

Please enter the gitlab-ci token <span class="token keyword" data-v-c316f882>for</span> this runner:
<span class="token comment" data-v-c316f882># 项目的 token</span>

Please enter the gitlab-ci description <span class="token keyword" data-v-c316f882>for</span> this runner:
<span class="token comment" data-v-c316f882># Runner 的 description</span>

Please enter the gitlab-ci tags <span class="token keyword" data-v-c316f882>for</span> this runner <span class="token punctuation" data-v-c316f882>(</span>comma separated<span class="token punctuation" data-v-c316f882>)</span>:
<span class="token comment" data-v-c316f882># Runner 的 tag</span>

Whether to run untagged builds <span class="token punctuation" data-v-c316f882>[</span>true/false<span class="token punctuation" data-v-c316f882>]</span>:
<span class="token comment" data-v-c316f882># true</span>

Please enter the executor: docker, parallels, shell, kubernetes, docker-ssh, ssh, virtualbox, docker+machine, docker-ssh+machine:
<span class="token comment" data-v-c316f882># docker</span>

Please enter the default Docker image <span class="token punctuation" data-v-c316f882>(</span>e.g. ruby:2.1<span class="token punctuation" data-v-c316f882>)</span>:
<span class="token comment" data-v-c316f882># 填入构建 Docker image 时填写的 image 名称</span></code></pre></div><p data-v-c316f882>这时 runner 就会出现在 <code data-v-c316f882>runners</code> 页面：</p> <p data-v-c316f882><img src="//gbstatic.djyde.com/assets/006tNc79gy1fetbnh1e12j310008qdgs.jpg" alt="" data-v-c316f882></p> <h2 id="faq" data-v-c316f882>FAQ</h2> <h3 id="ci-运行时出现-error-job-failed-api-error-404-repository-xxx-not-found-does-not-exist-or-no-pull-access" data-v-c316f882>CI 运行时出现 <code data-v-c316f882>ERROR: Job failed: API error (404): repository xxx not found: does not exist or no pull access</code></h3> <p data-v-c316f882>这是由于 Gitlab 会默认从远程拉取 image，而我们的 image 是在本地构建的，所以需要对 gitlab-runner 进行配置，把 <code data-v-c316f882>pull_policy</code> 设置为 <code data-v-c316f882>if-not-present</code> 或 <code data-v-c316f882>never</code>.</p> <div class="saber-highlight" data-lang="bash" data-v-c316f882><pre class="saber-highlight-code language-bash" data-v-c316f882><code class="language-bash" data-v-c316f882><span class="token comment" data-v-c316f882># 进入 gitlab-runner 的 bash 环境</span>
<span class="token function" data-v-c316f882>sudo</span> docker <span class="token builtin class-name" data-v-c316f882>exec</span> -it gitlab-runner <span class="token function" data-v-c316f882>bash</span>

<span class="token comment" data-v-c316f882># 编辑 config.toml</span>
<span class="token function" data-v-c316f882>nano</span> /etc/gitlab-runner/config.toml</code></pre></div><p data-v-c316f882>编辑 <code data-v-c316f882>config.toml</code> 中对应的 runner:</p> <div class="saber-highlight" data-lang="diff" data-v-c316f882><pre class="saber-highlight-code language-diff" data-v-c316f882><code class="language-diff" data-v-c316f882>[[runners]]
<span class="token unchanged" data-v-c316f882>  name = &quot;&quot;
  url = &quot;&quot;
  token = &quot;&quot;
  executor = &quot;docker&quot;
  [runners.docker]
    tls_verify = false
    image = &quot;nb-node&quot;
    privileged = false
    disable_cache = false
    volumes = [&quot;/cache&quot;]
</span><span class="token inserted-sign inserted" data-v-c316f882>+   pull_policy = &quot;if-not-present&quot;
</span><span class="token unchanged" data-v-c316f882>  [runners.cache]
</span></code></pre></div><h2 id="延伸阅读" data-v-c316f882>延伸阅读</h2> <ul data-v-c316f882><li data-v-c316f882><a rel="noopener noreferrer" target="_blank" href="https://docs.gitlab.com/runner/install/docker.html" data-v-c316f882>Run GitLab Runner in a container</a></li> <li data-v-c316f882><a rel="noopener noreferrer" target="_blank" href="https://www.daocloud.io/mirror#accelerator-doc" data-v-c316f882>配置 Docker 加速器</a></li> <li data-v-c316f882><a rel="noopener noreferrer" target="_blank" href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/" data-v-c316f882>Best practices for writing Dockerfiles</a></li> <li data-v-c316f882><a rel="noopener noreferrer" target="_blank" href="https://docs.gitlab.com/runner/executors/docker.html#using-the-if-not-present-pull-policy" data-v-c316f882>Using the if-not-present pull policy</a></li></ul></div> <div class="post-footer" data-v-c316f882><hr data-v-c316f882> <p data-v-c316f882>讨论请发邮件到 randypriv@gmail.com</p> <p data-v-c316f882>未经授权，禁止转载</p> <p data-v-c316f882>通过支付宝 djyde520@gmail.com 或赞赏码赞助此文</p> <p data-v-c316f882>
        或通过订阅我的
        <a href="/blog/my-zsxq/" data-v-c316f882>知识星球</a>支持本博客
      </p> <br data-v-c316f882> <p data-v-c316f882><img src="//gbstatic.djyde.com/assets/006tKfTcgy1fkuufy2cadj30w00w0tb2.jpg" class="bmc" data-v-c316f882></p></div></div></div> <div id="footer"><p><img width="256px" src="//s2.ax1x.com/2019/04/04/A2V9YT.png"></p> <p>
      2014-2019
      <a href="/" class="router-link-active">Randy's Blog</a></p></div></div></div><script src="/_saber/js/client.56031d8e.js" defer></script><script src="/_saber/js/page--_posts-gitlab-ci-runner-md.abd4e160.js" defer></script></body></html>
