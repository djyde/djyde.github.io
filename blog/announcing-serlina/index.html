<!DOCTYPE html><html data-saber-ssr><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.11.2"><meta data-saber-head="ssr" name="og:site_name" content="Randy&#x27;s Blog"><meta data-saber-head="ssr" property="title" content="Serlina: 渐进式的 React 服务器渲染框架 - Randy&#x27;s Blog"><meta data-saber-head="ssr" property="description" content="&lt;p&gt;副标题: 《可能是最适合 Egg 的 React Serverside-rendering 方案》&lt;/p&gt;
"><meta data-saber-head="ssr" property="og:description" content="&lt;p&gt;副标题: 《可能是最适合 Egg 的 React Serverside-rendering 方案》&lt;/p&gt;
"><meta data-saber-head="ssr" property="twitter:description" content="&lt;p&gt;副标题: 《可能是最适合 Egg 的 React Serverside-rendering 方案》&lt;/p&gt;
"><meta data-saber-head="ssr" property="og:title" content="Serlina: 渐进式的 React 服务器渲染框架 - Randy&#x27;s Blog"><meta data-saber-head="ssr" property="og:type" content="article"><meta data-saber-head="ssr" property="article:published_time" content="2018-08-13 17:44:09"><meta data-saber-head="ssr" property="twitter:title" content="Serlina: 渐进式的 React 服务器渲染框架 - Randy&#x27;s Blog"><meta data-saber-head="ssr" property="og:url" content="https://lutaonan.com/blog/announcing-serlina"><meta data-saber-head="ssr" property="og:image" content="https://gbstatic.djyde.com/assets/Snapseed%203.jpg?x-oss-process=image/auto-orient,1/quality,q_80/bright,-10/resize,w_2560/contrast,-30/interlace,1"><meta data-saber-head="ssr" property="twitter:image" content="https://gbstatic.djyde.com/assets/Snapseed%203.jpg?x-oss-process=image/auto-orient,1/quality,q_80/bright,-10/resize,w_2560/contrast,-30/interlace,1"> <title>Serlina: 渐进式的 React 服务器渲染框架 - Randy&#x27;s Blog</title> <link data-saber-head="ssr" rel="stylesheet" href="//ppp.djyde.com/css?family=Noto+Serif+SC"><link rel="stylesheet" href="/_saber/css/styles.2c5e9edc.chunk.css">  </head><body><div id="_saber" data-server-rendered="true"><div><div data-v-12b68786><nav class="bg-black flex text-white item-center font-serif" data-v-5fd162c6 data-v-12b68786><div class="text font-bold mr-4 p-1 pl-4" data-v-5fd162c6><a href="/" class="router-link-active" data-v-5fd162c6>Randy's Blog</a></div> <div class="flex item-center" data-v-5fd162c6><a href="/" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1 router-link-active" data-v-5fd162c6>寫作</a></div><div class="flex item-center" data-v-5fd162c6><a href="/readings" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1" data-v-5fd162c6>我讀</a></div><div class="flex item-center" data-v-5fd162c6><a href="/music" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1" data-v-5fd162c6>音樂</a></div><div class="flex item-center" data-v-5fd162c6><a href="/about" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1" data-v-5fd162c6>關於我</a></div></nav> <!----> <div class="post container mx-auto lg:pl-48 lg:pr-48" data-v-12b68786><h1 class="pl-4 pr-4" data-v-12b68786>Serlina: 渐进式的 React 服务器渲染框架</h1> <div class="text-sm text-gray-500 pl-4 pr-4" data-v-12b68786>August 13, 2018</div> <div class="content" data-v-12b68786><blockquote data-v-12b68786><p data-v-12b68786>副标题: 《可能是最适合 Egg 的 React Serverside-rendering 方案》</p></blockquote> <p data-v-12b68786>上一周周末我花了些时间来完成了一个 React serverside-rendering 框架——<a rel="noopener noreferrer" target="_blank" href="https://github.com/djyde/serlina" data-v-12b68786>Serlina</a>. 在此想通过这篇文章讲讲 Serlina 框架本身，以及我为什么要开发她。</p> <p data-v-12b68786>(下文中 React Serverside-rendering 均简称为 &quot;SSR&quot;)</p> <h2 id="起因" data-v-12b68786>起因</h2> <p data-v-12b68786>最直接的起因是我们在内部有一个 React base 的项目的首页希望做服务器渲染，我参考了一些方案，如 Next.js, Fusion.js 等等。我很喜欢 Next.js, 我从他刚发布的时候就在持续关注，我认为他已经是最完美的 SSR 方案。</p> <p data-v-12b68786>但是当我试图把 Next.js 接入到我们的服务器端 (<a rel="noopener noreferrer" target="_blank" href="https://eggjs.org" data-v-12b68786>Egg.js</a> base) 时，我发现 <a rel="noopener noreferrer" target="_blank" href="https://github.com/eggjs/egg/issues/328" data-v-12b68786>由于 Next.js 需要控制 http context</a>, 导致无法兼容 Egg 程序。</p> <p data-v-12b68786>我认为 Next.js 的核心应该可以脱离 http context. 只需要完成构建配置、renderToString 这些脏活，然后把渲染后的 HTML String 返回即可。于是我浏览了 Next.js 的代码，试图寻找类似 <code data-v-12b68786>nextjs/core</code> 的东西，然而并没有。Next.js 是一个完整的 Web Framework.</p> <p data-v-12b68786>于是我开始设计一个理念是<strong data-v-12b68786>脱离服务器实现</strong>的 SSR 框架，并取名为 Serlina. 她和 Next.js 拥有同样友好的开发体验，唯一不同之处是，她不关心服务器实现。</p> <h2 id="最简单的例子" data-v-12b68786>最简单的例子</h2> <p data-v-12b68786>安装依赖</p> <div class="saber-highlight" data-lang="" data-v-12b68786><pre class="saber-highlight-code language-text" data-v-12b68786><code class="language-text" data-v-12b68786>npm i serlina react react-dom --save</code></pre></div><p data-v-12b68786>创建一个应用目录</p> <div class="saber-highlight" data-lang="bash" data-v-12b68786><pre class="saber-highlight-code language-bash" data-v-12b68786><code class="language-bash" data-v-12b68786>├── index.js
├── page
│   └── page1.js</code></pre></div><p data-v-12b68786>编写一个 React 页面</p> <div class="saber-highlight" data-lang="js" data-v-12b68786><pre class="saber-highlight-code language-js" data-v-12b68786><code class="language-js" data-v-12b68786><span class="token comment" data-v-12b68786>// page/page1.js</span>

<span class="token keyword" data-v-12b68786>export</span> <span class="token keyword" data-v-12b68786>default</span> <span class="token punctuation" data-v-12b68786>(</span><span class="token punctuation" data-v-12b68786>)</span> <span class="token operator" data-v-12b68786>=&gt;</span> <span class="token punctuation" data-v-12b68786>{</span>
  <span class="token keyword" data-v-12b68786>return</span> <span class="token operator" data-v-12b68786>&lt;</span>div<span class="token operator" data-v-12b68786>&gt;</span>Hello Serlina<span class="token operator" data-v-12b68786>!</span><span class="token operator" data-v-12b68786>&lt;</span><span class="token operator" data-v-12b68786>/</span>div<span class="token operator" data-v-12b68786>&gt;</span>
<span class="token punctuation" data-v-12b68786>}</span></code></pre></div><p data-v-12b68786>最后是服务器的实现</p> <div class="saber-highlight" data-lang="js" data-v-12b68786><pre class="saber-highlight-code language-js" data-v-12b68786><code class="language-js" data-v-12b68786><span class="token comment" data-v-12b68786>// index.js</span>

<span class="token keyword" data-v-12b68786>const</span> <span class="token punctuation" data-v-12b68786>{</span> Serlina <span class="token punctuation" data-v-12b68786>}</span> <span class="token operator" data-v-12b68786>=</span> <span class="token function" data-v-12b68786>require</span><span class="token punctuation" data-v-12b68786>(</span><span class="token string" data-v-12b68786>'serlina'</span><span class="token punctuation" data-v-12b68786>)</span>
<span class="token keyword" data-v-12b68786>const</span> path <span class="token operator" data-v-12b68786>=</span> <span class="token function" data-v-12b68786>require</span><span class="token punctuation" data-v-12b68786>(</span><span class="token string" data-v-12b68786>'path'</span><span class="token punctuation" data-v-12b68786>)</span>

<span class="token keyword" data-v-12b68786>const</span> http <span class="token operator" data-v-12b68786>=</span> <span class="token function" data-v-12b68786>require</span><span class="token punctuation" data-v-12b68786>(</span><span class="token string" data-v-12b68786>'http'</span><span class="token punctuation" data-v-12b68786>)</span>

<span class="token comment" data-v-12b68786>// 初始化 Serlina</span>
<span class="token keyword" data-v-12b68786>const</span> serlina <span class="token operator" data-v-12b68786>=</span> <span class="token keyword" data-v-12b68786>new</span> <span class="token class-name" data-v-12b68786>Serlina</span><span class="token punctuation" data-v-12b68786>(</span><span class="token punctuation" data-v-12b68786>{</span>
  baseDir<span class="token punctuation" data-v-12b68786>:</span> path<span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>resolve</span><span class="token punctuation" data-v-12b68786>(</span>__dirname<span class="token punctuation" data-v-12b68786>,</span> <span class="token string" data-v-12b68786>'./'</span><span class="token punctuation" data-v-12b68786>)</span>
<span class="token punctuation" data-v-12b68786>}</span><span class="token punctuation" data-v-12b68786>)</span>

serlina<span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>prepare</span><span class="token punctuation" data-v-12b68786>(</span><span class="token punctuation" data-v-12b68786>)</span>
  <span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>then</span><span class="token punctuation" data-v-12b68786>(</span><span class="token punctuation" data-v-12b68786>(</span><span class="token punctuation" data-v-12b68786>)</span> <span class="token operator" data-v-12b68786>=&gt;</span> <span class="token punctuation" data-v-12b68786>{</span>
    http<span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>createServer</span><span class="token punctuation" data-v-12b68786>(</span><span class="token keyword" data-v-12b68786>async</span> <span class="token punctuation" data-v-12b68786>(</span><span class="token parameter" data-v-12b68786>req<span class="token punctuation" data-v-12b68786>,</span> res</span><span class="token punctuation" data-v-12b68786>)</span> <span class="token operator" data-v-12b68786>=&gt;</span> <span class="token punctuation" data-v-12b68786>{</span>
        res<span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>writeHead</span><span class="token punctuation" data-v-12b68786>(</span><span class="token number" data-v-12b68786>200</span><span class="token punctuation" data-v-12b68786>,</span> <span class="token punctuation" data-v-12b68786>{</span> <span class="token string" data-v-12b68786>'Content-Type'</span><span class="token punctuation" data-v-12b68786>:</span> <span class="token string" data-v-12b68786>'text/html'</span> <span class="token punctuation" data-v-12b68786>}</span><span class="token punctuation" data-v-12b68786>)</span>
        <span class="token keyword" data-v-12b68786>if</span> <span class="token punctuation" data-v-12b68786>(</span>req<span class="token punctuation" data-v-12b68786>.</span>url <span class="token operator" data-v-12b68786>===</span> <span class="token string" data-v-12b68786>'/page1'</span><span class="token punctuation" data-v-12b68786>)</span> <span class="token punctuation" data-v-12b68786>{</span>
          <span class="token comment" data-v-12b68786>// 渲染页面</span>
          <span class="token keyword" data-v-12b68786>const</span> rendered <span class="token operator" data-v-12b68786>=</span> <span class="token keyword" data-v-12b68786>await</span> serlina<span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>render</span><span class="token punctuation" data-v-12b68786>(</span><span class="token string" data-v-12b68786>'page1'</span><span class="token punctuation" data-v-12b68786>)</span>
          res<span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>write</span><span class="token punctuation" data-v-12b68786>(</span>rendered<span class="token punctuation" data-v-12b68786>.</span>string<span class="token punctuation" data-v-12b68786>)</span>
        <span class="token punctuation" data-v-12b68786>}</span> <span class="token keyword" data-v-12b68786>else</span> <span class="token punctuation" data-v-12b68786>{</span>
          res<span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>write</span><span class="token punctuation" data-v-12b68786>(</span><span class="token string" data-v-12b68786>'works!'</span><span class="token punctuation" data-v-12b68786>)</span>
        <span class="token punctuation" data-v-12b68786>}</span>
        res<span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>end</span><span class="token punctuation" data-v-12b68786>(</span><span class="token punctuation" data-v-12b68786>)</span>
    <span class="token punctuation" data-v-12b68786>}</span><span class="token punctuation" data-v-12b68786>)</span><span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>listen</span><span class="token punctuation" data-v-12b68786>(</span><span class="token number" data-v-12b68786>8090</span><span class="token punctuation" data-v-12b68786>)</span>
  <span class="token punctuation" data-v-12b68786>}</span><span class="token punctuation" data-v-12b68786>)</span>
  <span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>catch</span><span class="token punctuation" data-v-12b68786>(</span>console<span class="token punctuation" data-v-12b68786>.</span>error<span class="token punctuation" data-v-12b68786>)</span></code></pre></div><p data-v-12b68786>通过以上的例子，Serlina 有两个最主要的 API:</p> <ul data-v-12b68786><li data-v-12b68786><code data-v-12b68786>prepare()</code> 用于做构建准备</li> <li data-v-12b68786><code data-v-12b68786>render()</code> 用于渲染 React 页面, 得到 HTML string.</li></ul> <p data-v-12b68786>以上的例子也表达了 Serlina 的核心思想——她处理了 React 服务器渲染的一切脏活，然后把处理好的东西交给你自己去渲染到客户端。</p> <p data-v-12b68786>这就是「渐进式」的意思：你可以在某些地方用她，也可以在某些地方不用她。你可以只在某个路由里面使用 serlina.render() 去渲染。这有点像是一个模板引擎。</p> <h2 id="在-egg-中使用" data-v-12b68786>在 Egg 中使用</h2> <p data-v-12b68786><a rel="noopener noreferrer" target="_blank" href="https://github.com/serlina-community/egg-serlina" data-v-12b68786>egg-serlina</a></p> <p data-v-12b68786>我之所以认为 Serlina 是最适合 Egg 的 SSR 方案，是因为我认为 Next.js 是最好的 SSR 方案。而 Serlina 把 Next.js 的体验带到了 Egg, 那么她应该就是最适合 Egg 的 SSR 方案。</p> <blockquote data-v-12b68786><p data-v-12b68786>以下内容非 Egg 用户可以跳过。</p></blockquote> <div class="saber-highlight" data-lang="" data-v-12b68786><pre class="saber-highlight-code language-text" data-v-12b68786><code class="language-text" data-v-12b68786>npm i egg-serlina react react-dom --save</code></pre></div><div class="saber-highlight" data-lang="js" data-v-12b68786><pre class="saber-highlight-code language-js" data-v-12b68786><code class="language-js" data-v-12b68786>exports<span class="token punctuation" data-v-12b68786>.</span>serlina <span class="token operator" data-v-12b68786>=</span> <span class="token punctuation" data-v-12b68786>{</span>
  map<span class="token punctuation" data-v-12b68786>:</span> <span class="token punctuation" data-v-12b68786>{</span>
    <span class="token string" data-v-12b68786>'/page1'</span><span class="token punctuation" data-v-12b68786>:</span> <span class="token string" data-v-12b68786>'page1'</span>
  <span class="token punctuation" data-v-12b68786>}</span>
<span class="token punctuation" data-v-12b68786>}</span></code></pre></div><p data-v-12b68786>配置了用 Serlina 渲染的页面后，页面会在 <code data-v-12b68786>getInitialProps</code> 里得到 egg 的 ctx:</p> <div class="saber-highlight" data-lang="js" data-v-12b68786><pre class="saber-highlight-code language-js" data-v-12b68786><code class="language-js" data-v-12b68786><span class="token comment" data-v-12b68786>// {app_root}/client/page/page1.js</span>

<span class="token keyword" data-v-12b68786>export</span> <span class="token keyword" data-v-12b68786>default</span> <span class="token keyword" data-v-12b68786>class</span> <span class="token class-name" data-v-12b68786>Page1</span> <span class="token keyword" data-v-12b68786>extends</span> <span class="token class-name" data-v-12b68786>React<span class="token punctuation" data-v-12b68786>.</span>Component</span> <span class="token punctuation" data-v-12b68786>{</span>

  <span class="token keyword" data-v-12b68786>static</span> <span class="token keyword" data-v-12b68786>async</span> <span class="token function" data-v-12b68786>getInitialProps</span><span class="token punctuation" data-v-12b68786>(</span><span class="token parameter" data-v-12b68786><span class="token punctuation" data-v-12b68786>{</span> ctx <span class="token punctuation" data-v-12b68786>}</span></span><span class="token punctuation" data-v-12b68786>)</span> <span class="token punctuation" data-v-12b68786>{</span>
    <span class="token comment" data-v-12b68786>// ctx is egg `ctx`</span>
    <span class="token keyword" data-v-12b68786>return</span> <span class="token punctuation" data-v-12b68786>{</span>
      data<span class="token punctuation" data-v-12b68786>:</span> <span class="token keyword" data-v-12b68786>await</span> ctx<span class="token punctuation" data-v-12b68786>.</span>service<span class="token punctuation" data-v-12b68786>.</span><span class="token function" data-v-12b68786>getData</span><span class="token punctuation" data-v-12b68786>(</span><span class="token punctuation" data-v-12b68786>)</span>
    <span class="token punctuation" data-v-12b68786>}</span>
  <span class="token punctuation" data-v-12b68786>}</span>

  <span class="token function" data-v-12b68786>render</span> <span class="token punctuation" data-v-12b68786>(</span><span class="token punctuation" data-v-12b68786>)</span> <span class="token punctuation" data-v-12b68786>{</span>
    <span class="token keyword" data-v-12b68786>return</span> <span class="token punctuation" data-v-12b68786>(</span>
      <span class="token operator" data-v-12b68786>&lt;</span>div<span class="token operator" data-v-12b68786>&gt;</span><span class="token punctuation" data-v-12b68786>{</span><span class="token keyword" data-v-12b68786>this</span><span class="token punctuation" data-v-12b68786>.</span>props<span class="token punctuation" data-v-12b68786>.</span>data<span class="token punctuation" data-v-12b68786>}</span><span class="token operator" data-v-12b68786>&lt;</span><span class="token operator" data-v-12b68786>/</span>div<span class="token operator" data-v-12b68786>&gt;</span>
    <span class="token punctuation" data-v-12b68786>)</span>
  <span class="token punctuation" data-v-12b68786>}</span>
<span class="token punctuation" data-v-12b68786>}</span></code></pre></div><h2 id="常被问到的问题" data-v-12b68786>常被问到的问题</h2> <h3 id="和-next-js-有什么区别" data-v-12b68786>和 Next.js 有什么区别</h3> <p data-v-12b68786>关于这个问题，上文已经说得很清楚了。另外，Serlina 并不是要取代 Next.js, 而是希望在某些场景，能成为一种合适的选择。</p></div></div> <div class="post text-center text-sm" data-v-12b68786><hr class="mt-12 mb-12" data-v-12b68786> <p data-v-12b68786>讨论请发邮件到 randypriv@gmail.com</p> <p data-v-12b68786>未经授权，禁止转载</p> <p data-v-12b68786>通过支付宝 djyde520@gmail.com 或赞赏码赞助此文</p> <p data-v-12b68786>
      或通过订阅我的
      <a href="/blog/my-zsxq/" data-v-12b68786 data-v-12b68786>知识星球</a>支持本博客
    </p> <br data-v-12b68786> <p data-v-12b68786><img src="https://gbstatic.djyde.com/assets/006tKfTcgy1fkuufy2cadj30w00w0tb2.jpg" class="w-auto sm:w-64 mx-auto" data-v-12b68786></p></div></div> <div class="font-serif text-sm text-center p-12 sm:p-32 text-gray-500 font-bold"><div>
      2014-2019
      <a href="/" class="router-link-active">Randy's Blog</a></div> <div class="mt-2">
      可通過
      <a href="/rss.xml" class="border-b-4">RSS</a> 或
      <a rel="noopener noreferrer" target="_blank" href="https://tinyletter.com/randysblog" class="border-b-4">Email</a> 訂閱本博客
    </div></div></div></div><script src="/_saber/js/styles.2c5e9edc.js" defer></script><script src="/_saber/js/page--_posts-announcing-serlina-md.9dc0d8a7.js" defer></script><script src="/_saber/js/client.4d7c860d.js" defer></script></body></html>
