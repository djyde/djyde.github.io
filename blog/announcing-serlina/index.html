<!DOCTYPE html><html data-saber-ssr><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.11.2"><meta data-saber-head="ssr" property="title" content="Serlina: 渐进式的 React 服务器渲染框架 - Randy&#x27;s Blog"><meta data-saber-head="ssr" property="description" content="&lt;p&gt;副标题: 《可能是最适合 Egg 的 React Serverside-rendering 方案》&lt;/p&gt;
"><meta data-saber-head="ssr" property="og:description" content="&lt;p&gt;副标题: 《可能是最适合 Egg 的 React Serverside-rendering 方案》&lt;/p&gt;
"><meta data-saber-head="ssr" property="twitter:description" content="&lt;p&gt;副标题: 《可能是最适合 Egg 的 React Serverside-rendering 方案》&lt;/p&gt;
"><meta data-saber-head="ssr" property="og:title" content="Serlina: 渐进式的 React 服务器渲染框架 - Randy&#x27;s Blog"><meta data-saber-head="ssr" property="twitter:title" content="Serlina: 渐进式的 React 服务器渲染框架 - Randy&#x27;s Blog"><meta data-saber-head="ssr" property="og:url" content="https://lutaonan.com/blog/announcing-serlina"><meta data-saber-head="ssr" property="og:image" content="https://gbstatic.djyde.com/assets/Snapseed%203.jpg?x-oss-process=image/auto-orient,1/quality,q_80/bright,-10/resize,w_2560/contrast,-30/interlace,1"><meta data-saber-head="ssr" property="twitter:image" content="https://gbstatic.djyde.com/assets/Snapseed%203.jpg?x-oss-process=image/auto-orient,1/quality,q_80/bright,-10/resize,w_2560/contrast,-30/interlace,1"> <title>Serlina: 渐进式的 React 服务器渲染框架 - Randy&#x27;s Blog</title> <link data-saber-head="ssr" rel="stylesheet" href="//ppp.djyde.com/css?family=Noto+Serif+SC"><link rel="stylesheet" href="/_saber/css/styles.d51a47c0.chunk.css">  </head><body><div id="_saber" data-server-rendered="true"><div><div data-v-6f164c47><nav class="bg-black flex text-gray-300 item-center font-serif" data-v-7513afea data-v-6f164c47><div class="text font-bold mr-4 p-1 pl-4" data-v-7513afea><a href="/" class="router-link-active" data-v-7513afea>Randy's Blog</a></div> <div class="flex item-center" data-v-7513afea><a href="/" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1 router-link-active" data-v-7513afea>寫作</a></div><div class="flex item-center" data-v-7513afea><a href="/readings" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1" data-v-7513afea>我讀</a></div><div class="flex item-center" data-v-7513afea><a href="/music" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1" data-v-7513afea>音樂</a></div><div class="flex item-center" data-v-7513afea><a href="/about" class="mr-4 hover:bg-gray-300 hover:text-gray-900 p-1" data-v-7513afea>關於我</a></div></nav> <!----> <div class="post container mx-auto lg:pl-48 lg:pr-48" data-v-6f164c47><h1 class="pl-4 pr-4" data-v-6f164c47>Serlina: 渐进式的 React 服务器渲染框架</h1> <div class="text-sm text-gray-500 pl-4 pr-4" data-v-6f164c47>August 13, 2018</div> <div class="content" data-v-6f164c47><blockquote data-v-6f164c47><p data-v-6f164c47>副标题: 《可能是最适合 Egg 的 React Serverside-rendering 方案》</p></blockquote> <p data-v-6f164c47>上一周周末我花了些时间来完成了一个 React serverside-rendering 框架——<a rel="noopener noreferrer" target="_blank" href="https://github.com/djyde/serlina" data-v-6f164c47>Serlina</a>. 在此想通过这篇文章讲讲 Serlina 框架本身，以及我为什么要开发她。</p> <p data-v-6f164c47>(下文中 React Serverside-rendering 均简称为 &quot;SSR&quot;)</p> <h2 id="起因" data-v-6f164c47>起因</h2> <p data-v-6f164c47>最直接的起因是我们在内部有一个 React base 的项目的首页希望做服务器渲染，我参考了一些方案，如 Next.js, Fusion.js 等等。我很喜欢 Next.js, 我从他刚发布的时候就在持续关注，我认为他已经是最完美的 SSR 方案。</p> <p data-v-6f164c47>但是当我试图把 Next.js 接入到我们的服务器端 (<a rel="noopener noreferrer" target="_blank" href="https://eggjs.org" data-v-6f164c47>Egg.js</a> base) 时，我发现 <a rel="noopener noreferrer" target="_blank" href="https://github.com/eggjs/egg/issues/328" data-v-6f164c47>由于 Next.js 需要控制 http context</a>, 导致无法兼容 Egg 程序。</p> <p data-v-6f164c47>我认为 Next.js 的核心应该可以脱离 http context. 只需要完成构建配置、renderToString 这些脏活，然后把渲染后的 HTML String 返回即可。于是我浏览了 Next.js 的代码，试图寻找类似 <code data-v-6f164c47>nextjs/core</code> 的东西，然而并没有。Next.js 是一个完整的 Web Framework.</p> <p data-v-6f164c47>于是我开始设计一个理念是<strong data-v-6f164c47>脱离服务器实现</strong>的 SSR 框架，并取名为 Serlina. 她和 Next.js 拥有同样友好的开发体验，唯一不同之处是，她不关心服务器实现。</p> <h2 id="最简单的例子" data-v-6f164c47>最简单的例子</h2> <p data-v-6f164c47>安装依赖</p> <div class="saber-highlight" data-lang="" data-v-6f164c47><pre class="saber-highlight-code language-text" data-v-6f164c47><code class="language-text" data-v-6f164c47>npm i serlina react react-dom --save</code></pre></div><p data-v-6f164c47>创建一个应用目录</p> <div class="saber-highlight" data-lang="bash" data-v-6f164c47><pre class="saber-highlight-code language-bash" data-v-6f164c47><code class="language-bash" data-v-6f164c47>├── index.js
├── page
│   └── page1.js</code></pre></div><p data-v-6f164c47>编写一个 React 页面</p> <div class="saber-highlight" data-lang="js" data-v-6f164c47><pre class="saber-highlight-code language-js" data-v-6f164c47><code class="language-js" data-v-6f164c47><span class="token comment" data-v-6f164c47>// page/page1.js</span>

<span class="token keyword" data-v-6f164c47>export</span> <span class="token keyword" data-v-6f164c47>default</span> <span class="token punctuation" data-v-6f164c47>(</span><span class="token punctuation" data-v-6f164c47>)</span> <span class="token operator" data-v-6f164c47>=&gt;</span> <span class="token punctuation" data-v-6f164c47>{</span>
  <span class="token keyword" data-v-6f164c47>return</span> <span class="token operator" data-v-6f164c47>&lt;</span>div<span class="token operator" data-v-6f164c47>&gt;</span>Hello Serlina<span class="token operator" data-v-6f164c47>!</span><span class="token operator" data-v-6f164c47>&lt;</span><span class="token operator" data-v-6f164c47>/</span>div<span class="token operator" data-v-6f164c47>&gt;</span>
<span class="token punctuation" data-v-6f164c47>}</span></code></pre></div><p data-v-6f164c47>最后是服务器的实现</p> <div class="saber-highlight" data-lang="js" data-v-6f164c47><pre class="saber-highlight-code language-js" data-v-6f164c47><code class="language-js" data-v-6f164c47><span class="token comment" data-v-6f164c47>// index.js</span>

<span class="token keyword" data-v-6f164c47>const</span> <span class="token punctuation" data-v-6f164c47>{</span> Serlina <span class="token punctuation" data-v-6f164c47>}</span> <span class="token operator" data-v-6f164c47>=</span> <span class="token function" data-v-6f164c47>require</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token string" data-v-6f164c47>'serlina'</span><span class="token punctuation" data-v-6f164c47>)</span>
<span class="token keyword" data-v-6f164c47>const</span> path <span class="token operator" data-v-6f164c47>=</span> <span class="token function" data-v-6f164c47>require</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token string" data-v-6f164c47>'path'</span><span class="token punctuation" data-v-6f164c47>)</span>

<span class="token keyword" data-v-6f164c47>const</span> http <span class="token operator" data-v-6f164c47>=</span> <span class="token function" data-v-6f164c47>require</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token string" data-v-6f164c47>'http'</span><span class="token punctuation" data-v-6f164c47>)</span>

<span class="token comment" data-v-6f164c47>// 初始化 Serlina</span>
<span class="token keyword" data-v-6f164c47>const</span> serlina <span class="token operator" data-v-6f164c47>=</span> <span class="token keyword" data-v-6f164c47>new</span> <span class="token class-name" data-v-6f164c47>Serlina</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token punctuation" data-v-6f164c47>{</span>
  baseDir<span class="token punctuation" data-v-6f164c47>:</span> path<span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>resolve</span><span class="token punctuation" data-v-6f164c47>(</span>__dirname<span class="token punctuation" data-v-6f164c47>,</span> <span class="token string" data-v-6f164c47>'./'</span><span class="token punctuation" data-v-6f164c47>)</span>
<span class="token punctuation" data-v-6f164c47>}</span><span class="token punctuation" data-v-6f164c47>)</span>

serlina<span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>prepare</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token punctuation" data-v-6f164c47>)</span>
  <span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>then</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token punctuation" data-v-6f164c47>)</span> <span class="token operator" data-v-6f164c47>=&gt;</span> <span class="token punctuation" data-v-6f164c47>{</span>
    http<span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>createServer</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token keyword" data-v-6f164c47>async</span> <span class="token punctuation" data-v-6f164c47>(</span><span class="token parameter" data-v-6f164c47>req<span class="token punctuation" data-v-6f164c47>,</span> res</span><span class="token punctuation" data-v-6f164c47>)</span> <span class="token operator" data-v-6f164c47>=&gt;</span> <span class="token punctuation" data-v-6f164c47>{</span>
        res<span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>writeHead</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token number" data-v-6f164c47>200</span><span class="token punctuation" data-v-6f164c47>,</span> <span class="token punctuation" data-v-6f164c47>{</span> <span class="token string" data-v-6f164c47>'Content-Type'</span><span class="token punctuation" data-v-6f164c47>:</span> <span class="token string" data-v-6f164c47>'text/html'</span> <span class="token punctuation" data-v-6f164c47>}</span><span class="token punctuation" data-v-6f164c47>)</span>
        <span class="token keyword" data-v-6f164c47>if</span> <span class="token punctuation" data-v-6f164c47>(</span>req<span class="token punctuation" data-v-6f164c47>.</span>url <span class="token operator" data-v-6f164c47>===</span> <span class="token string" data-v-6f164c47>'/page1'</span><span class="token punctuation" data-v-6f164c47>)</span> <span class="token punctuation" data-v-6f164c47>{</span>
          <span class="token comment" data-v-6f164c47>// 渲染页面</span>
          <span class="token keyword" data-v-6f164c47>const</span> rendered <span class="token operator" data-v-6f164c47>=</span> <span class="token keyword" data-v-6f164c47>await</span> serlina<span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>render</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token string" data-v-6f164c47>'page1'</span><span class="token punctuation" data-v-6f164c47>)</span>
          res<span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>write</span><span class="token punctuation" data-v-6f164c47>(</span>rendered<span class="token punctuation" data-v-6f164c47>.</span>string<span class="token punctuation" data-v-6f164c47>)</span>
        <span class="token punctuation" data-v-6f164c47>}</span> <span class="token keyword" data-v-6f164c47>else</span> <span class="token punctuation" data-v-6f164c47>{</span>
          res<span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>write</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token string" data-v-6f164c47>'works!'</span><span class="token punctuation" data-v-6f164c47>)</span>
        <span class="token punctuation" data-v-6f164c47>}</span>
        res<span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>end</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token punctuation" data-v-6f164c47>)</span>
    <span class="token punctuation" data-v-6f164c47>}</span><span class="token punctuation" data-v-6f164c47>)</span><span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>listen</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token number" data-v-6f164c47>8090</span><span class="token punctuation" data-v-6f164c47>)</span>
  <span class="token punctuation" data-v-6f164c47>}</span><span class="token punctuation" data-v-6f164c47>)</span>
  <span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>catch</span><span class="token punctuation" data-v-6f164c47>(</span>console<span class="token punctuation" data-v-6f164c47>.</span>error<span class="token punctuation" data-v-6f164c47>)</span></code></pre></div><p data-v-6f164c47>通过以上的例子，Serlina 有两个最主要的 API:</p> <ul data-v-6f164c47><li data-v-6f164c47><code data-v-6f164c47>prepare()</code> 用于做构建准备</li> <li data-v-6f164c47><code data-v-6f164c47>render()</code> 用于渲染 React 页面, 得到 HTML string.</li></ul> <p data-v-6f164c47>以上的例子也表达了 Serlina 的核心思想——她处理了 React 服务器渲染的一切脏活，然后把处理好的东西交给你自己去渲染到客户端。</p> <p data-v-6f164c47>这就是「渐进式」的意思：你可以在某些地方用她，也可以在某些地方不用她。你可以只在某个路由里面使用 serlina.render() 去渲染。这有点像是一个模板引擎。</p> <h2 id="在-egg-中使用" data-v-6f164c47>在 Egg 中使用</h2> <p data-v-6f164c47><a rel="noopener noreferrer" target="_blank" href="https://github.com/serlina-community/egg-serlina" data-v-6f164c47>egg-serlina</a></p> <p data-v-6f164c47>我之所以认为 Serlina 是最适合 Egg 的 SSR 方案，是因为我认为 Next.js 是最好的 SSR 方案。而 Serlina 把 Next.js 的体验带到了 Egg, 那么她应该就是最适合 Egg 的 SSR 方案。</p> <blockquote data-v-6f164c47><p data-v-6f164c47>以下内容非 Egg 用户可以跳过。</p></blockquote> <div class="saber-highlight" data-lang="" data-v-6f164c47><pre class="saber-highlight-code language-text" data-v-6f164c47><code class="language-text" data-v-6f164c47>npm i egg-serlina react react-dom --save</code></pre></div><div class="saber-highlight" data-lang="js" data-v-6f164c47><pre class="saber-highlight-code language-js" data-v-6f164c47><code class="language-js" data-v-6f164c47>exports<span class="token punctuation" data-v-6f164c47>.</span>serlina <span class="token operator" data-v-6f164c47>=</span> <span class="token punctuation" data-v-6f164c47>{</span>
  map<span class="token punctuation" data-v-6f164c47>:</span> <span class="token punctuation" data-v-6f164c47>{</span>
    <span class="token string" data-v-6f164c47>'/page1'</span><span class="token punctuation" data-v-6f164c47>:</span> <span class="token string" data-v-6f164c47>'page1'</span>
  <span class="token punctuation" data-v-6f164c47>}</span>
<span class="token punctuation" data-v-6f164c47>}</span></code></pre></div><p data-v-6f164c47>配置了用 Serlina 渲染的页面后，页面会在 <code data-v-6f164c47>getInitialProps</code> 里得到 egg 的 ctx:</p> <div class="saber-highlight" data-lang="js" data-v-6f164c47><pre class="saber-highlight-code language-js" data-v-6f164c47><code class="language-js" data-v-6f164c47><span class="token comment" data-v-6f164c47>// {app_root}/client/page/page1.js</span>

<span class="token keyword" data-v-6f164c47>export</span> <span class="token keyword" data-v-6f164c47>default</span> <span class="token keyword" data-v-6f164c47>class</span> <span class="token class-name" data-v-6f164c47>Page1</span> <span class="token keyword" data-v-6f164c47>extends</span> <span class="token class-name" data-v-6f164c47>React<span class="token punctuation" data-v-6f164c47>.</span>Component</span> <span class="token punctuation" data-v-6f164c47>{</span>

  <span class="token keyword" data-v-6f164c47>static</span> <span class="token keyword" data-v-6f164c47>async</span> <span class="token function" data-v-6f164c47>getInitialProps</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token parameter" data-v-6f164c47><span class="token punctuation" data-v-6f164c47>{</span> ctx <span class="token punctuation" data-v-6f164c47>}</span></span><span class="token punctuation" data-v-6f164c47>)</span> <span class="token punctuation" data-v-6f164c47>{</span>
    <span class="token comment" data-v-6f164c47>// ctx is egg `ctx`</span>
    <span class="token keyword" data-v-6f164c47>return</span> <span class="token punctuation" data-v-6f164c47>{</span>
      data<span class="token punctuation" data-v-6f164c47>:</span> <span class="token keyword" data-v-6f164c47>await</span> ctx<span class="token punctuation" data-v-6f164c47>.</span>service<span class="token punctuation" data-v-6f164c47>.</span><span class="token function" data-v-6f164c47>getData</span><span class="token punctuation" data-v-6f164c47>(</span><span class="token punctuation" data-v-6f164c47>)</span>
    <span class="token punctuation" data-v-6f164c47>}</span>
  <span class="token punctuation" data-v-6f164c47>}</span>

  <span class="token function" data-v-6f164c47>render</span> <span class="token punctuation" data-v-6f164c47>(</span><span class="token punctuation" data-v-6f164c47>)</span> <span class="token punctuation" data-v-6f164c47>{</span>
    <span class="token keyword" data-v-6f164c47>return</span> <span class="token punctuation" data-v-6f164c47>(</span>
      <span class="token operator" data-v-6f164c47>&lt;</span>div<span class="token operator" data-v-6f164c47>&gt;</span><span class="token punctuation" data-v-6f164c47>{</span><span class="token keyword" data-v-6f164c47>this</span><span class="token punctuation" data-v-6f164c47>.</span>props<span class="token punctuation" data-v-6f164c47>.</span>data<span class="token punctuation" data-v-6f164c47>}</span><span class="token operator" data-v-6f164c47>&lt;</span><span class="token operator" data-v-6f164c47>/</span>div<span class="token operator" data-v-6f164c47>&gt;</span>
    <span class="token punctuation" data-v-6f164c47>)</span>
  <span class="token punctuation" data-v-6f164c47>}</span>
<span class="token punctuation" data-v-6f164c47>}</span></code></pre></div><h2 id="常被问到的问题" data-v-6f164c47>常被问到的问题</h2> <h3 id="和-next-js-有什么区别" data-v-6f164c47>和 Next.js 有什么区别</h3> <p data-v-6f164c47>关于这个问题，上文已经说得很清楚了。另外，Serlina 并不是要取代 Next.js, 而是希望在某些场景，能成为一种合适的选择。</p></div></div> <div class="post text-center text-sm" data-v-6f164c47><hr class="mt-12 mb-12" data-v-6f164c47> <p data-v-6f164c47>讨论请发邮件到 randypriv@gmail.com</p> <p data-v-6f164c47>未经授权，禁止转载</p> <p data-v-6f164c47>通过支付宝 djyde520@gmail.com 或赞赏码赞助此文</p> <p data-v-6f164c47>
      或通过订阅我的
      <a href="/blog/my-zsxq/" data-v-6f164c47 data-v-6f164c47>知识星球</a>支持本博客
    </p> <br data-v-6f164c47> <p data-v-6f164c47><img src="https://gbstatic.djyde.com/assets/006tKfTcgy1fkuufy2cadj30w00w0tb2.jpg" class="w-auto sm:w-64 mx-auto" data-v-6f164c47></p></div></div> <div class="font-serif text-sm text-center p-12 sm:p-32 text-gray-500 font-bold"><div>
      2014-2019
      <a href="/" class="router-link-active">Randy's Blog</a></div> <div class="mt-2">
      可通過 <a href="/rss.xml" class="border-b-4">RSS</a> 或 <a rel="noopener noreferrer" target="_blank" href="https://tinyletter.com/randysblog" class="border-b-4">Email</a> 訂閱本博客
    </div></div></div></div><script src="/_saber/js/styles.d51a47c0.js" defer></script><script src="/_saber/js/page--_posts-announcing-serlina-md.51a93fb8.js" defer></script><script src="/_saber/js/client.08dc9a11.js" defer></script></body></html>
